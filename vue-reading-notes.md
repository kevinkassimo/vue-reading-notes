# Vue Reading Notes

This is my own notes of reading the `vue-next` (Vue 3.0) source code. I am a React user and has never used Vue before, so I think it would be interesting to read through its source code while going through its docs and guide (especially that my understanding of virtual DOM is really hand-wavy).

Since the notes is only for my own benefit, it will be pretty disorganized, as I document fun things I find along the way. There is no doubt I will make mistakes and get confused all the time.

The source code I am reading is a snapshot taken at `f7c54caeb1dac69a26b79c98409e9633a7fe4bd3` on May 19, 2021. Most recent version number is `3.1.0-beta.3`. This notes is written using Typora for easier reading, and it might use a dialect of Markdown.

### Runtime Stuff

+ `Vue.createApp` is from `runtime-dom` pkg.

  + References an internal renderer (created from `runtime-core`, `createRenderer()`). `baseCreateRenderer()`

    + TODO: What is a renderer?

  + Internally calls the renderer's `createApp`, obtained from `createAppAPI()`

  + Wraps raw `mount`. If component is not a function or without `render` and else, uses `container.innerHTML` as template and clears it.

    + Applies to examples such as

    + ```js
      const Counter = { data() { return { counter: 0 }; } };
      Vue.createApp(Counter).mount('#counter')
      ```

    + The new `mount` returns a `proxy`.

      + TODO: what is this proxy?
      + Inner `mount` from `createAppAPI()` calls `createVNode()`
        + Either hydrates or renders on the vnode.
          + `render`
            + From `createAppAPI()`
            + Calls `patch(n1, n2, container, ...)`
              + More details see `patch(...)` section.
              + `n1` is set to `component._vnode`. Assume initially `null`
              + `n2` is set to the newly created `vnode`
          + TODO: `hydrate`

+ `vnode`

  + Likely an in-memory representation of a DOM node
  + Contains node type info
  + `el` seems to host actual DOM element.
  + `shapeFlag`:
    + Optimization only
    + TODO: what is it?
  + `patchFlag`:
    + Optimization hints generated by the compiler.
    + When a block with `dynamicChildren` is encountered during diff, the algorithm enters "optimized mode"
    + In this mode, we know that the vdom is produced by a render function generated by the compiler
    + So the algorithm only needs to handle updates explicitly marked by these patch flags.
    + See its actual usages in `patchElement`
    + Go to its file to understand each of the options (`shared/src/patchFlags.ts`)
  + TODO: what is a `prop`?
  + TODO: investigate more.

+ `baseCreateRenderer(options, createHydrationFns)`

  + Things related to how to insert a node to the host, get its relative position etc. is passed down from `options`
    + For basic version, they are just wrappers for normal DOM operations. See `nodeOps()` .

+ `patch(n1, n2, container, anchor = null, parentComponent = null, parentSuspense = null, isSVG = false, slotScopeIds = null, optimized = false)`

  + `n1` is a vnode
    + TODO: what is `n1`?
    + `n1` seems to be the old version of the vnode.
  + `n2` is a vnode
    + `n2` seems to be the vnode with incoming new changes we want to apply.
  + `anchor` is the node immediately after the self. It is used as a reference to where to insert before (when both under a common parent).
  + Check `n2.type`
    + `Text` :  Just create and insert to host and save on `n2.el`, or, if `n1` is non-null, copies `n2.el = n1.el` and set `el` with new children text.
    + `Comment`: create. No support for dynamic comment updates.
    + `Static`:
      + TODO: This does not look like a DOM nodeType... What is it?
        + Guessing from `insertStaticContent(...)`, seems to create a SVG/div container, and dump content as inner HTML to it. Each element in the container is then inserted to host, and returns the first and last element back.
          + Seems to be a hack to insert multiple children with raw HTML as source?
          + Comment from source code: static nodes are only present when used with `compiler-dom/runtime-dom`
        + Per comment, "static nodes are only patched during dev for HMR" (HMR: Hot Module Replacement)
      + If `n1 == null`, mount. Otherwise patch.
    + `Fragment`:
      + In this case, the `vnode.children` is a `type VNodeArrayChildren = Array<VNodeArrayChildren | VNodeChildAtom>`, where `VNodeChildAtom` could be a vnode or built-in JS values like strings and numbers
      + When mounting, each child is passed to `patch(...)` again for nested processing.
      + A fast path involves `patchBlockChildren`
        + TODO: maybe investigate why it is a fast path. What is a stable fragment?
      + When patching:
        + Fast path: Keyed and unkeyed child patch.
          + Only when `patchFlag > 0`
        + Slower path:
          + `shapeFlag` shows `TEXT_CHILDREN`:
            + Unmount old children and simply set text
          + There are also cases involving array children etc., and there are corresponding handling. Skip for now.
        + `patchUnkeyedChildren`: Basic dumb one by one patch while catering to different children lengths.
        + `patchKeyedChildren`:
          + Cater to both fully keyed and partial keyed.
          + Much more complicated.
          + Diffing Algorithm
            + Notice: during each pass, reduce the unpatched and unknown range at the center. All below are passes.
            + Sync from start, `(a b) c` vs `(a b) d e`. For commonly keyed prefix, run `patch`
            + Sync from end. Reverse of first step.
            + Common sequences?
              + Yes:
                + Common sequence + mount, when after prev 2 steps, the unknown range of one hits the boundary of list of children. Then we know th rest nodes are new nodes that should be mounted.
                + Common sequence + unmount. Opposite of above.
              + No:
                + The remaining range that cannot be deduced and patched in the previous passes.
                + Build key:index map for newChildren
                + Loop through old children left to be patched and try to patch matching nodes & remove nodes that are no longer present
                  + Notice: all modification (patch/unmount. Mount is in the next step) is completed here 
                + Move and mount (we only have either incorrectly ordered vnodes or vnodes yet to be mounted in this step)
                  + Generate longest stable subsequence only when nodes have moved
                  + Move if node outside of the longest subsequence (such that we can move as little number of vnodes as possible)
                  + Mount if new node.
                  + Using `anchor`s to know where to mount inside of the container
        + `move`: Responsible for moving nodes.
          + Suspense is optionally enabled here.
            + TODO: Investigate Suspense
          + If NO suspense
            + TODO: There are multiple cases here. Need further investigation
            + Static node behavior need more investigation (what is `anchor` here?)
            + TODO: what is a transition?
              + If need transition, ...
              + If not, plainly host insert.
        + `unmount`: 
          + `doRemove` argument controls whether to actually trigger `remove` action (e.g. DOM removal)
          + Invokes `onVnodeBeforeUnmount` hook
          + There is also a `unmountComponent` subroutine
          + Otherwise, similarly with or without suspense.
          + Invokes `beforeUnmount` directive hook
            + TODO: What is a directive?
        + `remove`:
          + Seems to be the real DOM removal.
    + `Element`: the real fun
      + `mountElement`
        + Create (or clone if reused) the DOM element
        + Mount children first.
          + Some props may rely on child content being already rendered, e.g. `<select value>`
        + Invokes `created` directive hook
        + Invokes `onVnodeBeforeMount` vnode hook
        + Invokes `beforeMount` directive hook
        + Transition entering processing. (TODO)
        + Actually insert the DOM element
        + Some post-render effect stuff (TODO)
      + `patchElement`
        + Invokes `onVnodeBeforeUpdate` vnode hook
        + Invokes `beforeUpdate` directive hook
        + Patches props
          + Fast paths for `style` and `class`
        + TODO: Continue reading from here next time.
    + `Component`:
    + `Teleport`: TODO
    + `Suspense`: TODO
  + ...

+ ...

